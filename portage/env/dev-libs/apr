EXTRA_ECONF='
    ac_cv_file__dev_zero=yes
    ac_cv_func_setpgrp_void=yes
    apr_cv_process_shared_works=yes
    apr_cv_mutex_robust_shared=no
    apr_cv_tcp_nodelay_with_cork=yes
    ac_cv_sizeof_struct_iovec=8
    ac_cv_struct_rlimit=yes
    apr_cv_mutex_recursive=yes'

post_src_prepare() {
	# Fix some thing the ebuild broke...
	# Using the system libtool causes it to use its idea of $LD, which is
	# the build system's variant; the libtool generated by configure
	# does the right thing.
	sed -e 's:/usr/bin/libtool:${installbuilddir}/libtool:' -i apr-config.in || die "sed failed"
	sed -e 's:$(SHELL) /usr/bin/libtool:@LIBTOOL@:' -i build/apr_rules.mk.in || die "sed failed"

	rm -f build/libtool.m4

	epatch_user
	AT_M4DIR="build" eautoreconf
}

pre_src_configure() {
	# Override rm to avoid deleting the generate libtool, for the reasons
	# described above.
	rm() {
		test "$*" = "-f libtool" && return
		command rm "$@"
	}
}

post_src_configure() {
	# A little bit of cleanup...
	unset rm
}

post_src_install() {
	sed -i -e "
		/^apr_builddir/ s:=:=$SYSROOT:
		/^apr_builders/ s:=:=$SYSROOT:
		/^top_builddir/ s:=:=$SYSROOT:
	" "${D}/usr/share/build-1/apr_rules.mk"

	sed -i -e "
		/^installbuilddir/ s:=":="$SYSROOT:
	" "${D}/usr/bin/apr-1-config"
}
